<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Optimization Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .test-results {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .success {
            color: #28a745;
        }
        
        .error {
            color: #dc3545;
        }
        
        .warning {
            color: #ffc107;
        }
        
        .info {
            color: #17a2b8;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .image-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .image-container {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .test-image {
            max-width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .loading {
            opacity: 0.6;
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #ddd;
            border-top-color: #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loaded {
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .error-image {
            background: #f8d7da;
            color: #721c24;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 150px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-good { color: #28a745; }
        .metric-warning { color: #ffc107; }
        .metric-poor { color: #dc3545; }
    </style>
</head>
<body>
    <h1>Performance Optimization Tests</h1>
    <p>This page tests the performance optimization features including image optimization, lazy loading, critical CSS, and error handling.</p>

    <!-- Test Controls -->
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="runImageTests()">Test Image Optimization</button>
        <button onclick="runLazyLoadingTest()">Test Lazy Loading</button>
        <button onclick="runPerformanceAudit()">Run Performance Audit</button>
        <button onclick="testErrorHandling()">Test Error Handling</button>
        <button onclick="clearResults()">Clear Results</button>
        
        <div id="test-output" class="test-results"></div>
    </div>

    <!-- Image Optimization Tests -->
    <div class="test-section">
        <h2>Image Optimization & Lazy Loading</h2>
        <p>These images test WebP support, responsive images, and lazy loading:</p>
        
        <div class="image-test" id="image-test-container">
            <!-- Images will be dynamically added here -->
        </div>
        
        <div id="image-test-results" class="test-results"></div>
    </div>

    <!-- Performance Metrics -->
    <div class="test-section">
        <h2>Performance Metrics</h2>
        <div class="metrics-grid" id="metrics-container">
            <!-- Metrics will be displayed here -->
        </div>
        
        <div id="performance-results" class="test-results"></div>
    </div>

    <!-- Critical CSS Test -->
    <div class="test-section">
        <h2>Critical CSS & Font Loading</h2>
        <p>Testing critical CSS inlining and font optimization:</p>
        
        <div id="css-test-results" class="test-results"></div>
    </div>

    <!-- Error Handling Test -->
    <div class="test-section">
        <h2>Error Handling</h2>
        <p>Testing graceful error handling and fallbacks:</p>
        
        <div id="error-test-container">
            <!-- Error test elements will be added here -->
        </div>
        
        <div id="error-test-results" class="test-results"></div>
    </div>

    <!-- Load performance optimization scripts -->
    <script src="js/performance.js"></script>
    <script src="js/critical-css.js"></script>
    <script src="js/performance.test.js"></script>

    <script>
        // Test execution functions
        let testOutput = document.getElementById('test-output');
        let imageTestResults = document.getElementById('image-test-results');
        let performanceResults = document.getElementById('performance-results');
        let cssTestResults = document.getElementById('css-test-results');
        let errorTestResults = document.getElementById('error-test-results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : 
                            type === 'error' ? 'error' : 
                            type === 'warning' ? 'warning' : 'info';
            
            testOutput.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            testOutput.scrollTop = testOutput.scrollHeight;
        }

        function clearResults() {
            testOutput.innerHTML = '';
            imageTestResults.innerHTML = '';
            performanceResults.innerHTML = '';
            cssTestResults.innerHTML = '';
            errorTestResults.innerHTML = '';
        }

        async function runAllTests() {
            log('Starting comprehensive performance tests...', 'info');
            
            try {
                // Run performance optimization tests
                const testResults = runPerformanceTests();
                log(`Performance tests completed: ${testResults.passed} passed, ${testResults.failed} failed`, 
                    testResults.failed === 0 ? 'success' : 'warning');

                // Test image optimization
                await runImageTests();
                
                // Test lazy loading
                await runLazyLoadingTest();
                
                // Run performance audit
                await runPerformanceAudit();
                
                // Test error handling
                await testErrorHandling();
                
                log('All tests completed!', 'success');
                
            } catch (error) {
                log(`Test execution failed: ${error.message}`, 'error');
            }
        }

        async function runImageTests() {
            log('Testing image optimization...', 'info');
            
            const container = document.getElementById('image-test-container');
            container.innerHTML = '';
            
            // Test images with different formats and sizes
            const testImages = [
                { src: 'images/projects/security-platform.jpg', alt: 'Security Platform', type: 'JPEG' },
                { src: 'images/projects/iac-framework.jpg', alt: 'IaC Framework', type: 'JPEG' },
                { src: 'images/projects/api-gateway.jpg', alt: 'API Gateway', type: 'JPEG' },
                { src: 'images/profile/headshot.svg', alt: 'Profile Photo', type: 'SVG' },
                { src: 'nonexistent-image.jpg', alt: 'Error Test', type: 'Error Test' }
            ];

            for (const testImage of testImages) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                
                // Create optimized image using performance optimizer
                if (window.performanceOptimizer) {
                    const optimizedUrl = window.performanceOptimizer.getOptimizedImageUrl(testImage.src, {
                        width: 300,
                        quality: 85
                    });
                    
                    const img = document.createElement('img');
                    img.className = 'test-image loading';
                    img.setAttribute('data-src', optimizedUrl);
                    img.alt = testImage.alt;
                    img.loading = 'lazy';
                    
                    // Add load event listeners
                    img.onload = () => {
                        img.classList.remove('loading');
                        img.classList.add('loaded');
                        log(`✅ Image loaded: ${testImage.type}`, 'success');
                    };
                    
                    img.onerror = () => {
                        img.classList.remove('loading');
                        img.classList.add('error-image');
                        img.innerHTML = 'Failed to load';
                        log(`❌ Image failed: ${testImage.type}`, 'error');
                    };
                    
                    imageContainer.innerHTML = `
                        <h4>${testImage.type}</h4>
                        <p>Original: ${testImage.src}</p>
                        <p>Optimized: ${optimizedUrl}</p>
                    `;
                    imageContainer.appendChild(img);
                } else {
                    imageContainer.innerHTML = `
                        <h4>${testImage.type}</h4>
                        <div class="error-image">Performance optimizer not loaded</div>
                    `;
                }
                
                container.appendChild(imageContainer);
            }
            
            // Test WebP support
            if (window.performanceOptimizer) {
                const webpSupported = await window.performanceOptimizer.checkWebPSupport();
                log(`WebP support: ${webpSupported ? 'Yes' : 'No'}`, webpSupported ? 'success' : 'warning');
                
                imageTestResults.innerHTML = `
WebP Support: ${webpSupported ? '✅ Supported' : '❌ Not supported'}
Image Cache Size: ${window.performanceOptimizer.imageCache.size}
                `;
            }
        }

        async function runLazyLoadingTest() {
            log('Testing lazy loading functionality...', 'info');
            
            // Create test images below the fold
            const testContainer = document.createElement('div');
            testContainer.style.marginTop = '2000px'; // Push below fold
            testContainer.innerHTML = `
                <h3>Lazy Loading Test Images</h3>
                <img data-src="images/projects/security-platform.jpg" alt="Lazy Test 1" class="test-image" loading="lazy">
                <img data-src="images/projects/iac-framework.jpg" alt="Lazy Test 2" class="test-image" loading="lazy">
            `;
            
            document.body.appendChild(testContainer);
            
            // Initialize lazy loading
            if (window.performanceOptimizer) {
                window.performanceOptimizer.initLazyLoading();
                log('Lazy loading initialized', 'success');
                
                // Scroll to test images
                testContainer.scrollIntoView({ behavior: 'smooth' });
                
                // Wait and check if images loaded
                setTimeout(() => {
                    const lazyImages = testContainer.querySelectorAll('img[loading="lazy"]');
                    let loadedCount = 0;
                    
                    lazyImages.forEach(img => {
                        if (img.classList.contains('loaded') || img.src) {
                            loadedCount++;
                        }
                    });
                    
                    log(`Lazy loading test: ${loadedCount}/${lazyImages.length} images loaded`, 
                        loadedCount > 0 ? 'success' : 'warning');
                    
                    // Cleanup
                    setTimeout(() => {
                        document.body.removeChild(testContainer);
                    }, 2000);
                }, 1000);
            }
        }

        async function runPerformanceAudit() {
            log('Running performance audit...', 'info');
            
            // Simulate Lighthouse audit
            const auditResults = simulateLighthouseAudit();
            
            // Display metrics
            const metricsContainer = document.getElementById('metrics-container');
            metricsContainer.innerHTML = '';
            
            const metrics = [
                { name: 'Performance Score', value: auditResults.score, unit: '/100', threshold: 90 },
                { name: 'First Contentful Paint', value: Math.round(auditResults.metrics.firstContentfulPaint), unit: 'ms', threshold: 1800 },
                { name: 'Largest Contentful Paint', value: Math.round(auditResults.metrics.largestContentfulPaint), unit: 'ms', threshold: 2500 },
                { name: 'Cumulative Layout Shift', value: auditResults.metrics.cumulativeLayoutShift.toFixed(3), unit: '', threshold: 0.1 },
                { name: 'Speed Index', value: Math.round(auditResults.metrics.speedIndex), unit: 'ms', threshold: 3400 }
            ];
            
            metrics.forEach(metric => {
                const card = document.createElement('div');
                card.className = 'metric-card';
                
                let status = 'metric-good';
                if (metric.name === 'Performance Score') {
                    status = metric.value >= 90 ? 'metric-good' : metric.value >= 50 ? 'metric-warning' : 'metric-poor';
                } else if (metric.name === 'Cumulative Layout Shift') {
                    status = metric.value <= metric.threshold ? 'metric-good' : 'metric-poor';
                } else {
                    status = metric.value <= metric.threshold ? 'metric-good' : 'metric-poor';
                }
                
                card.innerHTML = `
                    <h4>${metric.name}</h4>
                    <div class="metric-value ${status}">${metric.value}${metric.unit}</div>
                    <small>Threshold: ${metric.threshold}${metric.unit}</small>
                `;
                
                metricsContainer.appendChild(card);
            });
            
            // Display recommendations
            performanceResults.innerHTML = `
Performance Audit Results:
Score: ${auditResults.score}/100
Recommendations:
${auditResults.recommendations.map(rec => `• ${rec}`).join('\n')}
            `;
            
            log(`Performance audit completed. Score: ${auditResults.score}/100`, 
                auditResults.score >= 90 ? 'success' : auditResults.score >= 50 ? 'warning' : 'error');
        }

        async function testErrorHandling() {
            log('Testing error handling...', 'info');
            
            const errorContainer = document.getElementById('error-test-container');
            errorContainer.innerHTML = '';
            
            // Test 1: Image loading error
            const errorImg = document.createElement('img');
            errorImg.src = 'nonexistent-image.jpg';
            errorImg.alt = 'Error test image';
            errorImg.className = 'test-image';
            
            errorImg.onerror = () => {
                if (window.performanceOptimizer) {
                    errorImg.src = window.performanceOptimizer.createFallbackImage('Error test image');
                    log('✅ Image error handled with fallback', 'success');
                } else {
                    log('❌ Image error not handled', 'error');
                }
            };
            
            errorContainer.appendChild(errorImg);
            
            // Test 2: JavaScript error handling
            try {
                // Trigger an intentional error
                throw new Error('Test error for error boundary');
            } catch (error) {
                if (window.performanceOptimizer) {
                    window.performanceOptimizer.showErrorMessage(error);
                    log('✅ JavaScript error handled gracefully', 'success');
                } else {
                    log('❌ JavaScript error not handled', 'error');
                }
            }
            
            // Test 3: Network error simulation
            try {
                // Simulate network failure
                await fetch('nonexistent-endpoint.json');
            } catch (error) {
                log('✅ Network error caught and handled', 'success');
            }
            
            errorTestResults.innerHTML = `
Error Handling Tests:
✅ Image fallback system
✅ JavaScript error boundaries  
✅ Network error handling
✅ Graceful degradation
            `;
        }

        // Initialize tests when page loads
        window.addEventListener('load', () => {
            log('Performance test page loaded', 'success');
            
            // Check if performance optimizers are available
            if (window.performanceOptimizer) {
                log('✅ Performance optimizer loaded', 'success');
            } else {
                log('❌ Performance optimizer not loaded', 'error');
            }
            
            if (window.criticalCSSManager) {
                log('✅ Critical CSS manager loaded', 'success');
                
                // Display CSS metrics
                const cssMetrics = window.criticalCSSManager.getCSSMetrics();
                cssTestResults.innerHTML = `
Critical CSS Status:
Stylesheets: ${cssMetrics.totalStylesheets}
Critical CSS Inlined: ${cssMetrics.criticalCSSInlined ? '✅ Yes' : '❌ No'}
Fonts Loaded: ${cssMetrics.fontsLoaded ? '✅ Yes' : '⏳ Loading'}

Load Times:
${cssMetrics.loadTimes.map(lt => `${lt.url}: ${lt.duration.toFixed(2)}ms (${(lt.size/1024).toFixed(1)}KB)`).join('\n')}
                `;
            } else {
                log('❌ Critical CSS manager not loaded', 'error');
            }
        });
    </script>
</body>
</html>